<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Manager - Swastik CMS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body class="admin-page">
    <div class="admin-layout">
        <!-- Sidebar (same as index.html) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-brand">Swastik CMS</h2>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-page="dashboard">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="14" y="14" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="hero.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <line x1="3" y1="9" x2="21" y2="9" />
                            </svg>
                            <span>Hero Sections</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="products.html" class="nav-link active">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                                <line x1="3" y1="6" x2="21" y2="6" />
                                <path d="M16 10a4 4 0 0 1-8 0" />
                            </svg>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="collections.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                                <rect x="14" y="14" width="7" height="7" />
                            </svg>
                            <span>Collections</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="testimonials.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                            </svg>
                            <span>Testimonials</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="services.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <span>Services</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="faqs.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                            </svg>
                            <span>FAQs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="partners.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                            </svg>
                            <span>Partners</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <span>Site Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-ghost btn-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <h1 class="page-title">Products</h1>
                </div>
                <div class="topbar-right">
                    <button class="btn btn-primary" id="add-product-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        Add Product
                    </button>
                </div>
            </header>

            <div class="content-area">
                <!-- Filters -->
                <div class="card">
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <select id="category-filter" class="form-control" style="max-width: 200px;">
                                <option value="">All Categories</option>
                            </select>
                            <select id="status-filter" class="form-control" style="max-width: 150px;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                            <input type="text" id="search-input" class="form-control" placeholder="Search products..."
                                style="max-width: 300px;">
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Badge</th>
                                    <th>Status</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Form Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Product</h3>
                <button class="modal-close" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">Product Name *</label>
                            <input type="text" id="product-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="product-category">Category *</label>
                            <select id="product-category" class="form-control" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-price">Price (₨) *</label>
                            <input type="number" id="product-price" class="form-control" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="product-original-price">Original Price (₨)</label>
                            <input type="number" id="product-original-price" class="form-control" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-badge">Badge</label>
                            <select id="product-badge" class="form-control">
                                <option value="">None</option>
                                <option value="Premium">Premium</option>
                                <option value="New">New</option>
                                <option value="Bestseller">Bestseller</option>
                                <option value="Sale">Sale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-order">Display Order</label>
                            <input type="number" id="product-order" class="form-control" value="0" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-features">Features (comma separated)</label>
                        <input type="text" id="product-features" class="form-control"
                            placeholder="e.g., Italian Leather, Solid Wood, 3-Seater">
                    </div>

                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="image-upload" id="image-upload-area">
                            <div class="image-upload-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" />
                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                    <polyline points="21 15 16 10 5 21" />
                                </svg>
                            </div>
                            <p class="image-upload-text">
                                <strong>Click to upload</strong> or drag and drop<br>
                                PNG, JPG up to 5MB
                            </p>
                            <input type="file" id="product-image" accept="image/*" style="display: none;">
                        </div>
                        <div class="image-preview" id="image-preview" style="display: none;">
                            <img id="preview-img" src="" alt="Preview">
                            <button type="button" class="image-preview-remove" id="remove-image">×</button>
                        </div>
                        <input type="hidden" id="product-image-url">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="product-featured"> Featured Product
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="product-active" checked> Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancel-btn">Cancel</button>
                <button type="submit" form="product-form" class="btn btn-primary" id="save-btn">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-config.js"></script>
    <script src="../js/admin-auth.js"></script>
    <script src="../js/admin-app.js"></script>

    <script>
        // Products Page Logic
        document.addEventListener('DOMContentLoaded', async () => {
            const app = window.adminApp;
            const client = window.SupabaseConfig?.getClient();
            if (!client) return;

            // DOM Elements
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const tableBody = document.getElementById('products-table-body');
            const categoryFilter = document.getElementById('category-filter');
            const categorySelect = document.getElementById('product-category');
            const addBtn = document.getElementById('add-product-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const closeBtn = modal.querySelector('.modal-close');
            const imageUploadArea = document.getElementById('image-upload-area');
            const imageInput = document.getElementById('product-image');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const removeImageBtn = document.getElementById('remove-image');

            // Load categories
            async function loadCategories() {
                try {
                    const { data } = await client.from('product_categories').select('*').order('display_order');
                    if (data) {
                        const options = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        categoryFilter.innerHTML = '<option value="">All Categories</option>' + options;
                        categorySelect.innerHTML = '<option value="">Select Category</option>' + options;
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                }
            }

            // Load products
            async function loadProducts(categoryId = null) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Loading...</td></tr>';

                try {
                    let query = client.from('products')
                        .select('*, category:product_categories(name)')
                        .order('display_order');

                    if (categoryId) {
                        query = query.eq('category_id', categoryId);
                    }

                    const { data, error } = await query;
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No products found. Click "Add Product" to create one.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(product => `
                        <tr data-id="${product.id}">
                            <td>
                                <img src="${product.image_url || 'https://via.placeholder.com/48'}" alt="${app.escapeHtml(product.name)}" class="thumbnail">
                            </td>
                            <td><strong>${app.escapeHtml(product.name)}</strong></td>
                            <td>${product.category?.name || '-'}</td>
                            <td>₨${app.formatPrice(product.price)}</td>
                            <td>${product.badge || '-'}</td>
                            <td>
                                <span class="status-badge status-badge--${product.is_active ? 'active' : 'inactive'}">
                                    ${product.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td class="actions">
                                <button class="btn btn-sm btn-outline edit-btn" data-id="${product.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${product.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // Attach edit/delete handlers
                    tableBody.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', () => editProduct(btn.dataset.id));
                    });

                    tableBody.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
                    });

                } catch (error) {
                    console.error('Error loading products:', error);
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: red;">Error loading products</td></tr>';
                }
            }

            // Open modal for adding
            function openAddModal() {
                document.getElementById('modal-title').textContent = 'Add Product';
                form.reset();
                document.getElementById('product-id').value = '';
                document.getElementById('product-image-url').value = '';
                imagePreview.style.display = 'none';
                imageUploadArea.style.display = 'block';
                modal.classList.add('active');
            }

            // Open modal for editing
            async function editProduct(id) {
                try {
                    const { data, error } = await client.from('products').select('*').eq('id', id).single();
                    if (error) throw error;

                    document.getElementById('modal-title').textContent = 'Edit Product';
                    document.getElementById('product-id').value = data.id;
                    document.getElementById('product-name').value = data.name || '';
                    document.getElementById('product-category').value = data.category_id || '';
                    document.getElementById('product-description').value = data.description || '';
                    document.getElementById('product-price').value = data.price || '';
                    document.getElementById('product-original-price').value = data.original_price || '';
                    document.getElementById('product-badge').value = data.badge || '';
                    document.getElementById('product-order').value = data.display_order || 0;
                    document.getElementById('product-features').value = (data.features || []).join(', ');
                    document.getElementById('product-featured').checked = data.is_featured || false;
                    document.getElementById('product-active').checked = data.is_active !== false;
                    document.getElementById('product-image-url').value = data.image_url || '';

                    if (data.image_url) {
                        previewImg.src = data.image_url;
                        imagePreview.style.display = 'inline-block';
                        imageUploadArea.style.display = 'none';
                    } else {
                        imagePreview.style.display = 'none';
                        imageUploadArea.style.display = 'block';
                    }

                    modal.classList.add('active');
                } catch (error) {
                    console.error('Error loading product:', error);
                    app.showToast('Error loading product', 'error');
                }
            }

            // Close modal
            function closeModal() {
                modal.classList.remove('active');
            }

            // Delete product
            async function deleteProduct(id) {
                const confirmed = await app.confirm('Are you sure you want to delete this product? This action cannot be undone.');
                if (!confirmed) return;

                try {
                    await app.delete('products', id);
                    app.showToast('Product deleted successfully');
                    loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    app.showToast('Error deleting product', 'error');
                }
            }

            // Handle form submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = document.getElementById('product-id').value;
                const featuresStr = document.getElementById('product-features').value;
                const features = featuresStr ? featuresStr.split(',').map(f => f.trim()).filter(f => f) : [];

                const productData = {
                    name: document.getElementById('product-name').value,
                    category_id: document.getElementById('product-category').value || null,
                    description: document.getElementById('product-description').value,
                    price: parseFloat(document.getElementById('product-price').value) || 0,
                    original_price: parseFloat(document.getElementById('product-original-price').value) || null,
                    badge: document.getElementById('product-badge').value || null,
                    display_order: parseInt(document.getElementById('product-order').value) || 0,
                    features: features,
                    is_featured: document.getElementById('product-featured').checked,
                    is_active: document.getElementById('product-active').checked,
                    image_url: document.getElementById('product-image-url').value || null
                };

                try {
                    if (id) {
                        await app.update('products', id, productData);
                        app.showToast('Product updated successfully');
                    } else {
                        await app.create('products', productData);
                        app.showToast('Product created successfully');
                    }
                    closeModal();
                    loadProducts();
                } catch (error) {
                    console.error('Error saving product:', error);
                    app.showToast('Error saving product: ' + error.message, 'error');
                }
            });

            // Image upload handling
            imageUploadArea.addEventListener('click', () => imageInput.click());

            imageInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const url = await app.uploadImage('products', file);
                    document.getElementById('product-image-url').value = url;
                    previewImg.src = url;
                    imagePreview.style.display = 'inline-block';
                    imageUploadArea.style.display = 'none';
                    app.showToast('Image uploaded successfully');
                } catch (error) {
                    console.error('Error uploading image:', error);
                    app.showToast('Error uploading image', 'error');
                }
            });

            removeImageBtn.addEventListener('click', () => {
                document.getElementById('product-image-url').value = '';
                imagePreview.style.display = 'none';
                imageUploadArea.style.display = 'block';
                imageInput.value = '';
            });

            // Event listeners
            addBtn.addEventListener('click', openAddModal);
            cancelBtn.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            categoryFilter.addEventListener('change', () => {
                loadProducts(categoryFilter.value || null);
            });

            // Initialize
            await loadCategories();
            await loadProducts();
        });
    </script>
</body>

</html>